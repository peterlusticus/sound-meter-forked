<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schallpegel-Monitor (dB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #3b82f6; /* blue-500 */
            --color-danger: #ef4444; /* red-500 */
            --color-warning: #f59e0b; /* yellow-500 */
            --color-safe: #10b981; /* green-500 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        /* Keyframes for the pulse effect */
        @keyframes pulse-red {
            0%, 100% { background-color: #fef2f2; } /* red-50 */
            50% { background-color: #fee2e2; } /* red-100 */
        }

        .loud-background-pulse {
            animation: pulse-red 2s infinite ease-in-out;
        }

        /* Vertikaler Balken-Meter Container */
        .v-bar-meter-container {
            width: 80px; 
            height: 350px;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin: 2rem auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Die Füllung des Balkens */
        .v-bar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            left: 0;
            transition: height 0.1s ease-linear, background-color 0.1s ease-in;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .color-danger { background-color: var(--color-danger); }
        .color-warning { background-color: var(--color-warning); }
        .color-safe { background-color: var(--color-safe); }

        /* Die Schwellenwert-Linie */
        .v-bar-threshold-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--color-danger); 
            z-index: 10;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.9);
            transition: bottom 0.3s ease-out;
        }
        
        .main-display {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 4px solid #e5e7eb; /* gray-200 */
            transition: border-color 0.3s ease-in;
        }

        .main-display.is-loud {
            border-color: var(--color-danger);
        }
        
        @media (min-width: 1024px) {
            .main-content-wrapper {
                flex-direction: row;
                max-width: 1024px;
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <!-- NEU: Das Audio Element für den Alarm -->
    <!-- Stellen Sie sicher, dass die Datei unter 'public/airhorn.mp3' erreichbar ist -->
    <audio id="alarm-sound" src="./airhorn.mp3" preload="auto"></audio>

    <div id="app-container" class="w-full flex flex-col items-center justify-center">
        <div id="main-content-wrapper" class="max-w-4xl w-full flex flex-col lg:flex-row gap-8">
            
            <!-- Haupt-Anzeige: Balken und dB-Wert -->
            <div id="main-display" class="flex-1 flex flex-col items-center main-display">
                <h1 class="text-3xl font-extrabold mb-4 text-gray-800 text-center">
                    Schallpegel-Monitor (dB SPL)
                </h1>
                
                <div id="microphone-error" class="p-4 bg-red-100 text-red-700 rounded-lg mb-6 border border-red-300 w-full text-center hidden">
                    ⚠️ Fehler beim Mikrofonzugriff. Bitte Berechtigung erteilen.
                </div>

                <!-- Der vertikale Balken-Meter -->
                <div class="v-bar-meter-container">
                    <!-- Schwellenwert-Linie -->
                    <div id="threshold-line" class="v-bar-threshold-line" style="bottom: 0%;">
                        <span id="threshold-label" class="text-sm absolute -right-16 top-1/2 transform -translate-y-1/2 font-bold text-gray-700 bg-white px-1 py-0.5 rounded shadow">
                            0.0 dB
                        </span>
                    </div>
                    
                    <!-- Die eigentliche Füllung des Balkens -->
                    <div id="bar-fill" class="v-bar-fill color-safe" style="height: 0%;"></div>
                    
                    <!-- Skalen-Markierungen -->
                    <div class="absolute top-0 w-full h-full pointer-events-none text-gray-400 font-medium text-xs">
                         <div class="absolute top-[0%] left-full pl-2 -mt-2">120</div>
                         <div class="absolute top-[25%] left-full pl-2 -translate-y-1/2">90</div>
                         <div class="absolute top-[50%] left-full pl-2 -translate-y-1/2">60</div>
                         <div class="absolute top-[75%] left-full pl-2 -translate-y-1/2">30</div>
                         <div class="absolute bottom-0 left-full pl-2 -mb-2">0</div>
                    </div>
                </div>
                
                <!-- Aktueller dB-Wert -->
                <div class="mt-8 text-center">
                    <div id="current-db-display" class="text-6xl font-extrabold transition-colors duration-100 text-gray-900">
                        0.0
                    </div>
                    <div class="text-xl text-gray-500">
                        dB SPL (Geglättet)
                    </div>
                </div>

                <!-- Alarm-Meldung -->
                <div id="alarm-message" class="mt-6 p-3 bg-red-500 text-white rounded-lg font-bold shadow-lg hidden">
                    ⚠️ ZU LAUT! SCHWELLE ÜBERSCHRITTEN! ⚠️
                </div>
            </div> <!-- Schließt die Haupt-Anzeige -->

            <!-- Einstellungs-Panel -->
            <div class="lg:w-96 p-6 rounded-xl shadow-xl bg-white flex flex-col gap-4">
                <h3 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">
                    Einstellungen ⚙️
                </h3>

                <div class="input-group">
                    <label for="threshold-db-input" class="block text-sm font-medium text-gray-700 mb-1">
                        Grenzwert-Schwelle (dB):
                    </label>
                    <input
                        id="threshold-db-input"
                        type="number"
                        min="0"
                        max="120"
                        step="1"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        Aktuell: <strong id="threshold-output">70.0 dB</strong>
                    </p>
                </div>

                <div class="input-group">
                    <label for="delay-input" class="block text-sm font-medium text-gray-700 mb-1">
                        Alarm-Verzögerung (Millisekunden, ms):
                    </label>
                    <input
                        id="delay-input"
                        type="number"
                        min="0"
                        max="10000"
                        step="100"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        Alarm wird nach <strong id="delay-output">2000 ms</strong> Überschreitung ausgelöst.
                    </p>
                </div>

                <div class="input-group">
                    <label for="calibration-input" class="block text-sm font-medium text-gray-700 mb-1">
                        Kalibrierung (Offset dB):
                    </label>
                    <input
                        id="calibration-input"
                        type="number"
                        min="-20.0"
                        max="20.0"
                        step="0.1"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        Passt die Messung an das Mikrofon an.
                    </p>
                </div>
                
                <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
                    Mikrofon starten
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONSTANTEN ---
        const MAX_DB_DISPLAY = 100;
        const MIN_DB_DISPLAY = 0;
        const DBFS_OFFSET = MAX_DB_DISPLAY; 
        const CALIBRATION_OFFSET_DEFAULT = 0.0;
        const SMOOTHING_FACTOR = 0.9;
        const RMS_WINDOW_SIZE = 2048;
        // Die initialen Werte sind jetzt in Millisekunden
        const INITIAL_ALARM_DELAY_MS = 300;
        const ALARM_DURATION_MS = 2000;
        const INITIAL_WARNING_DB = 70;
        const UI_UPDATE_INTERVAL_MS = 100;

        // --- GLOBALER STATE (Simuliert React State/Refs) ---
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let audioDataArray = null;
        let animationFrameId = null;
        let uiUpdateIntervalId = null;

        let currentSmoothedDb = 0.0;
        let loudnessDuration = 0;
        let lastTimeCheck = performance.now();
        let alarmTriggered = false;
        let alarmTimeoutId = null;
        
        // Settings State
        let calibrationOffset = CALIBRATION_OFFSET_DEFAULT;
        let warningDbInput = INITIAL_WARNING_DB;
        // Wird direkt in Millisekunden gesetzt
        let currentAlarmDelayMs = INITIAL_ALARM_DELAY_MS; 
        
        // Derived State (RMS)
        let currentWarningRms = dbToRms(INITIAL_WARNING_DB, CALIBRATION_OFFSET_DEFAULT, DBFS_OFFSET);

        // --- DOM-ELEMENTE ZUM AKTUALISIEREN ---
        const $dbDisplay = document.getElementById('current-db-display');
        const $barFill = document.getElementById('bar-fill');
        const $thresholdLine = document.getElementById('threshold-line');
        const $thresholdLabel = document.getElementById('threshold-label');
        const $alarmMessage = document.getElementById('alarm-message');
        const $micError = document.getElementById('microphone-error');
        const $mainDisplay = document.getElementById('main-display');
        const $appContainer = document.getElementById('app-container');
        const $startButton = document.getElementById('start-button');
        // NEU: Audio Element Referenz
        const $alarmSound = document.getElementById('alarm-sound');

        // Input Felder
        const $thresholdInput = document.getElementById('threshold-db-input');
        const $delayInput = document.getElementById('delay-input');
        const $calibrationInput = document.getElementById('calibration-input');
        const $thresholdOutput = document.getElementById('threshold-output');
        const $delayOutput = document.getElementById('delay-output');

        // --- HILFSFUNKTIONEN ---

        function calculateDb(rms) {
            if (rms <= 0) return MIN_DB_DISPLAY + calibrationOffset;
            const dbfs = 20 * Math.log10(rms);
            let dbSPL = dbfs + DBFS_OFFSET + calibrationOffset;
            return Math.min(MAX_DB_DISPLAY, Math.max(MIN_DB_DISPLAY, dbSPL));
        }

        function dbToRms(db) {
            const dbfs = db - DBFS_OFFSET - calibrationOffset;
            let rms = Math.pow(10, dbfs / 20);
            return Math.min(1.0, Math.max(0.000001, rms));
        }
        
        function getBarFillPercentage(dbValue) {
            const min = MIN_DB_DISPLAY;
            const max = MAX_DB_DISPLAY;
            const limitedDb = Math.min(max, Math.max(min, dbValue));
            return ((limitedDb - min) / (max - min)) * 100;
        }

        // --- ALARM-LOGIK ---

        function resetAlarm() {
            if (alarmTimeoutId) {
                clearTimeout(alarmTimeoutId);
                alarmTimeoutId = null;
            }
            alarmTriggered = false;
            
            // UI Cleanup
            $alarmMessage.classList.add('hidden');
            $appContainer.classList.remove('loud-background-pulse');
            $mainDisplay.classList.remove('is-loud');
            $dbDisplay.classList.remove('text-red-600', 'animate-pulse');

            // NEU: Sound stoppen und zurücksetzen
            if($alarmSound) {
                $alarmSound.pause();
                $alarmSound.currentTime = 0;
            }
        }

        function setWarning() {
            if (alarmTriggered) return;

            alarmTriggered = true;

            // UI-Update: Alarm anzeigen
            $alarmMessage.classList.remove('hidden');
            $appContainer.classList.add('loud-background-pulse');
            $mainDisplay.classList.add('is-loud');
            $dbDisplay.classList.add('text-red-600', 'animate-pulse');

            // NEU: Sound abspielen
            if ($alarmSound) {
                $alarmSound.currentTime = 0; // Zurück zum Anfang, falls er schon lief
                $alarmSound.play().catch(e => {
                    console.warn("Autoplay blockiert oder Datei nicht gefunden:", e);
                });
            }

            // Timeout, um den visuellen Alarm nach ALARM_DURATION_MS zurückzusetzen
            alarmTimeoutId = setTimeout(() => {
                resetAlarm();
            }, ALARM_DURATION_MS);
        }

        // --- AUDIO-VERARBEITUNG: HAUPT-LOOP (RAF-basiert) ---

        function processAudio() {
            if (!analyser || !audioDataArray) {
                animationFrameId = requestAnimationFrame(processAudio);
                return;
            }

            // RMS Berechnung
            analyser.getFloatTimeDomainData(audioDataArray);
            let sumOfSquares = 0;
            for (let i = 0; i < audioDataArray.length; i++) {
                sumOfSquares += audioDataArray[i] * audioDataArray[i];
            }
            let rms = Math.sqrt(sumOfSquares / audioDataArray.length);

            // dB und Glättung
            const db = calculateDb(rms);
            currentSmoothedDb =
                SMOOTHING_FACTOR * currentSmoothedDb +
                (1 - SMOOTHING_FACTOR) * db;

            // Alarm-Logik
            const volumeThreshold = currentWarningRms;
            const now = performance.now();
            const delta = now - lastTimeCheck;
            lastTimeCheck = now;

            if (rms >= volumeThreshold) {
                loudnessDuration += delta;
                if (loudnessDuration >= currentAlarmDelayMs) {
                    setWarning();
                }
            } else {
                loudnessDuration = 0; 
                // Hinweis: Wir resetten den Alarm hier nicht sofort, damit er 
                // für die Dauer von ALARM_DURATION_MS sichtbar/hörbar bleibt.
                // Reset passiert via resetAlarm() timeout oder manuellem Reset.
            }

            animationFrameId = requestAnimationFrame(processAudio);
        }
        
        // --- UI-AKTUALISIERUNGS-LOOP (Niedrigfrequent, setInterval-basiert) ---
        function updateUI() {
            const currentDb = currentSmoothedDb;
            const thresholdDb = parseFloat(warningDbInput);
            
            // 1. dB-Zahl aktualisieren
            $dbDisplay.textContent = currentDb.toFixed(1);

            // 2. Balkenhöhe aktualisieren
            const barHeight = getBarFillPercentage(currentDb);
            $barFill.style.height = `${barHeight}%`;
            
            // 3. Balkenfarbe aktualisieren
            $barFill.classList.remove('color-safe', 'color-warning', 'color-danger');
            let barColorClass = 'color-safe'; // Standard: Grün
            if (currentDb >= thresholdDb) {
                barColorClass = 'color-danger'; // Rot bei Überschreitung
            } else if (currentDb >= 60) {
                barColorClass = 'color-warning'; // Gelb bei hohem Pegel
            }
            $barFill.classList.add(barColorClass);
        }

        // --- INITIALISIERUNG und EVENT HANDLER ---

        function cleanup() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (uiUpdateIntervalId) {
                clearInterval(uiUpdateIntervalId);
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().catch(e => console.error("Fehler beim Schließen des AudioContext:", e));
            }
            resetAlarm();
            $startButton.textContent = "Mikrofon starten";
            $startButton.disabled = false;
        }

        async function setupAudio() {
            cleanup(); // Immer zuerst aufräumen
            
            try {
                // AudioContext initialisieren (muss nach einer Nutzerinteraktion erfolgen)
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Mikrofonzugriff anfordern
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                $micError.classList.add('hidden');

                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(mediaStream);

                // Die fftSize muss mindestens doppelt so groß sein wie RMS_WINDOW_SIZE
                analyser.fftSize = Math.max(2048, RMS_WINDOW_SIZE * 2); 
                audioDataArray = new Float32Array(RMS_WINDOW_SIZE);

                microphone.connect(analyser);

                // Starte den Audio-Verarbeitungs-Loop
                lastTimeCheck = performance.now(); // Zurücksetzen für präzise Delta-Berechnung
                processAudio();
                
                // Starte den UI-Update-Loop
                uiUpdateIntervalId = setInterval(updateUI, UI_UPDATE_INTERVAL_MS);
                
                $startButton.textContent = "Läuft...";
                $startButton.disabled = true;

            } catch (err) {
                console.error("Fehler beim Zugriff auf das Mikrofon:", err);
                $micError.classList.remove('hidden');
                $startButton.textContent = "FEHLER: Neu starten";
                $startButton.disabled = false;
            }
        }
        
        function syncSettingsToLogic() {
            // Grenzwert (dB)
            const db = Number($thresholdInput.value);
            const limitedDb = Math.min(MAX_DB_DISPLAY, Math.max(MIN_DB_DISPLAY, db));
            warningDbInput = limitedDb;
            currentWarningRms = dbToRms(limitedDb);

            // Kalibrierung (Offset dB)
            calibrationOffset = Number($calibrationInput.value) || 0;
            
            // Verzögerung (ms) - HIER DIREKTE ÜBERNAHME
            const delayMs = Number($delayInput.value); 
            // Sicherstellen, dass der Wert >= 0 ist
            currentAlarmDelayMs = Math.max(0, delayMs);
            
            // UI-Ausgabe aktualisieren
            $thresholdOutput.textContent = `${limitedDb.toFixed(1)} dB`;
            $delayOutput.textContent = `${currentAlarmDelayMs} ms`;

            // Schwellenwert-Linie im Meter aktualisieren
            const thresholdPercent = getBarFillPercentage(limitedDb);
            $thresholdLine.style.bottom = `${thresholdPercent}%`;
            $thresholdLabel.textContent = `${limitedDb.toFixed(1)} dB`;
        }

        // --- DOMContentLoaded und Initialisierung ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Standardwerte setzen (jetzt in Millisekunden)
            $thresholdInput.value = INITIAL_WARNING_DB.toFixed(0);
            $delayInput.value = INITIAL_ALARM_DELAY_MS.toString(); // 2000 ms
            $calibrationInput.value = CALIBRATION_OFFSET_DEFAULT.toFixed(1);
            
            syncSettingsToLogic();

            // Event Listener für Änderungen
            $thresholdInput.addEventListener('input', syncSettingsToLogic);
            $delayInput.addEventListener('input', syncSettingsToLogic);
            $calibrationInput.addEventListener('input', syncSettingsToLogic);
            
            // Start-Button Handler (für User-Interaktion)
            $startButton.addEventListener('click', setupAudio);

            // Cleanup beim Verlassen der Seite
            window.addEventListener('beforeunload', cleanup);
        });

    </script>
</body>
</html>